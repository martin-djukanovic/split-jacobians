/* These are the curves from Example 3.6.
   The elliptic curves
   y^2 = x^3 - x^2 + x + 3
   y^2 = x*(x^2 + 44*x + 486)
   are 5-isogenous and covered 3-to-1 by y^2 = x*(2*x^2 + 4*x + 3)*(3*x^2 + 4*x + 2)
 
E1:=Curve(P2, -y^2*z + x^3 - x^2*z + x*z^2 + 3*z^3);
E2:=Curve(P2, -y^2*z + x*(x^2 + 44*x*z + 486*z^2));
isog:=map<E1->E2|[
	(z + x)*(7*z^2 - 10*x*z + x^2)^2*(-z^2 - 2*x*z + x^2),
	(7*z^2 - 10*x*z + x^2)*(41*z^4 + 12*x*z^3 + 10*x^2*z^2 + 4*x^3*z + x^4)*y,
	(-z^2 - 2*x*z + x^2)^3*z
]>;
***************************************************************************************/

R<x>:=PolynomialRing(QQ);
K<w,a>:=ext<QQ | [x^2 + x + 1, 243*x^12 - 5768*x^9 + 46848*x^6 - 124224*x^3 + 64] >;
P2<x,y,z>:=ProjectiveSpace(K,2);

// j=64/9
E1:=Curve(P2, x^3 + y^3 + z^3 + 3*a*x*y*z);
u:=101689011/1408*a^10 - 8146242755/4752*a^7 + 66161450963/4752*a^4 - 3986666857/108*a;
F1:=Curve(P2, -u*y^2*z + x^3 - x^2*z + x*z^2 + 3*z^3);

// j=-873722816/59049
b:=-81/32*a^11 + 721/12*a^8 - 488*a^5 + 3881/3*a^2;
E2:=Curve(P2, x^3 + y^3 + z^3 + 3*b*x*y*z);
v:=1/262415848474645888*(25371487221800985*a^11 - 521921432696737338*a^8 + 3459930408181806912*a^5 - 5802517949600740464*a^2);
F2:=Curve(P2, -v*y^2*z + x*(x^2 + 44*x*z + 486*z^2));


// isomorphisms from the Hesse to the Weierstrass models
g1:=map<E1->F1 | [
    -1/u*((1/197074944)*(a*(119053097247022901248*a^2*x - 240539388474405429461504*a^5*x + 118063846348169283126528*a^8*x - 22590230759173839349280*a^11*x + 2157703881330908248312*a^14*x - 104858701918192240416*a^17*x + 2163283538568125967*a^20*x + 119053097247022901248*a^2*y - 240539388474405429461504*a^5*y + 118063846348169283126528*a^8*y - 22590230759173839349280*a^11*y + 2157703881330908248312*a^14*y - 104858701918192240416*a^17*y + 2163283538568125967*a^20*y - 211256545863813120*z + 79680594605492736*a^3*z - 9810810524957184*a^6*z + 413328486858048*a^9*z))),
    -1/u^2*((1/11264)*(3*a^2*(-64 + 124480*a^3 - 12751*a^6 + 486*a^9)*(-823715915053608688 + 310684687579546336*a^3 - 38253587585966338*a^6 + 1611619900564437*a^9)*(x - y))),
    1/64*(-124224*a^2*x + 46848*a^5*x - 5768*a^8*x + 243*a^11*x - 124224*a^2*y + 46848*a^5*y - 5768*a^8*y +     243*a^11*y + 64*z)
]>;

g2:=map<E2->F2 | [
    -1/v*((1/2850790353883653056)*(19683*(-50097892234720*x + 61918984617398848*a^3*x - 12304256166192784*a^6*x + 683793592961805*a^9*x - 50097892234720*y + 61918984617398848*a^3*y - 12304256166192784*a^6*y + 683793592961805*a^9*y - 70642048420385344*a^2*z + 48734801899244512*a^5*z - 7662557889384670*a^8*z + 380430869157405*a^11*z))),
    -1/v^2*((177147*a*(-57318306510290991529472 + 7236545883545821892306456*a^3 - 1443380953451102679788540*a^6 + 79856859154404680043489*a^9)*(x - y))/856212697938421272781518208),
    (-51656*a*x + 36284*a^4*x - 5282*a^7*x + 243*a^10*x - 51656*a*y + 36284*a^4*y - 5282*a^7*y + 243*a^10*y + 34416*z)/34416
]>;

// the 5-isogeny on Weierstrass models
t:=-1/20785248*(2315256129*a^10 - 54955072514*a^7 + 446329664960*a^4 - 1183353743504*a);
isog:=map<F1->F2 | [
    (z + x)*(7*z^2 - 10*x*z + x^2)^2*(-z^2 - 2*x*z + x^2),
    t*(7*z^2 - 10*x*z + x^2)*(41*z^4 + 12*x*z^3 + 10*x^2*z^2 + 4*x^3*z + x^4)*y,
    (-z^2 - 2*x*z + x^2)^3*z
]>;

// the composition f: E1 --> E2, i.e. f = g2^-1 ∘ isog ∘ g1
f1:=-16816921735648*a*x^6*y + 6342915049984*a^4*x^6*y - 780982346668*a^7*x^6*y + 32902709814*a^10*x^6*y - 100901530413888*a*x^5*y^2 + 38057490299904*a^4*x^5*y^2 - 4685894080008*a^7*x^5*y^2 + 197416258884*a^10*x^5*y^2 - 252253826034720*a*x^4*y^3 + 95143725749760*a^4*x^4*y^3 - 11714735200020*a^7*x^4*y^3 + 493540647210*a^10*x^4*y^3 - 336338434712960*a*x^3*y^4 + 126858300999680*a^4*x^3*y^4 - 15619646933360*a^7*x^3*y^4 + 658054196280*a^10*x^3*y^4 - 252253826034720*a*x^2*y^5 + 95143725749760*a^4*x^2*y^5 - 11714735200020*a^7*x^2*y^5 + 493540647210*a^10*x^2*y^5 - 100901530413888*a*x*y^6 + 38057490299904*a^4*x*y^6 - 4685894080008*a^7*x*y^6 + 197416258884*a^10*x*y^6 - 16816921735648*a*y^7 + 6342915049984*a^4*y^7 - 780982346668*a^7*y^7 + 32902709814*a^10*y^7 - 757477360278112*a^2*x^6*z + 285701189844880*a^5*x^6*z - 35177451371212*a^8*x^6*z + 1482022582938*a^11*x^6*z - 3408648121251504*a^2*x^5*y*z + 1285655354301960*a^5*x^5*y*z - 158298531170454*a^8*x^5*y*z + 6669101623221*a^11*x^5*y*z - 5681080202085840*a^2*x^4*y^2*z + 2142758923836600*a^5*x^4*y^2*z - 263830885284090*a^8*x^4*y^2*z + 11115169372035*a^11*x^4*y^2*z - 3787386801390560*a^2*x^3*y^3*z + 1428505949224400*a^5*x^3*y^3*z - 175887256856060*a^8*x^3*y^3*z + 7410112914690*a^11*x^3*y^3*z + 1136216040417168*a^2*x*y^5*z - 428551784767320*a^5*x*y^5*z + 52766177056818*a^8*x*y^5*z - 2223033874407*a^11*x*y^5*z + 378738680139056*a^2*y^6*z - 142850594922440*a^5*y^6*z + 17588725685606*a^8*y^6*z - 741011291469*a^11*y^6*z + 585490403136*x^5*z^2 - 220832069808*a^3*x^5*z^2 + 27190328232*a^6*x^5*z^2 - 1145525814*a^9*x^5*z^2 + 4059879638016*x^4*y*z^2 - 1531283266560*a^3*x^4*y*z^2 + 188541887736*a^6*x^4*y*z^2 - 7943251068*a^9*x^4*y*z^2 + 10384614520704*x^3*y^2*z^2 - 3916812368160*a^3*x^3*y^2*z^2 + 482264268624*a^6*x^3*y^2*z^2 - 20317746132*a^9*x^3*y^2*z^2 + 12649469765376*x^2*y^3*z^2 - 4771058203200*a^3*x^2*y^3*z^2 + 587444761776*a^6*x^2*y^3*z^2 - 24748990128*a^9*x^2*y^3*z^2 + 7457162505024*x*y^4*z^2 - 2812652019120*a^3*x*y^4*z^2 + 346312627464*a^6*x*y^4*z^2 - 14590117062*a^9*x*y^4*z^2 + 1717918025472*y^5*z^2 - 647954987328*a^3*y^5*z^2 + 79780574808*a^6*y^5*z^2 - 3361147812*a^9*y^5*z^2 - 100901530413888*a*x^4*z^3 + 38057490299904*a^4*x^4*z^3 - 4685894080008*a^7*x^4*z^3 + 197416258884*a^10*x^4*z^3 - 287605587531488*a*x^3*y*z^3 + 108477510837056*a^4*x^3*y*z^3 - 13356480468164*a^7*x^3*y*z^3 + 562707214650*a^10*x^3*y*z^3 - 257407580111136*a*x^2*y^2*z^3 + 97087590711744*a^4*x^2*y^2*z^3 - 11954076924444*a^7*x^2*y^2*z^3 + 503624090646*a^10*x^2*y^2*z^3 - 55604519283360*a*x*y^3*z^3 + 20972610111936*a^4*x*y^3*z^3 - 2582288764428*a^7*x*y^3*z^3 + 108791572878*a^10*x*y^3*z^3 + 15099003710176*a*y^4*z^3 - 5694960062656*a^4*y^4*z^3 + 701201771860*a^7*y^4*z^3 - 29541562002*a^10*y^4*z^3 - 126484854104336*a^2*x^3*z^4 + 47706869172680*a^5*x^3*z^4 - 5873990485586*a^8*x^3*z^4 + 247470644259*a^11*x^3*z^4 + 454056886862496*a^2*x^2*y*z^4 - 171258706349568*a^5*x^2*y*z^4 + 21086523360036*a^8*x^2*y*z^4 - 888373164978*a^11*x^2*y*z^4 + 1287568336038000*a^2*x*y^2*z^4 - 485638020217176*a^5*x*y^2*z^4 + 59795018176830*a^8*x*y^2*z^4 - 2519158262733*a^11*x*y^2*z^4 + 707026595071168*a^2*y^3*z^4 - 266672444694928*a^5*y^3*z^4 + 32834504331208*a^8*y^3*z^4 - 1383314453496*a^11*y^3*z^4 + 507498794688*x^2*z^5 - 191415693072*a^3*x^2*z^5 + 23568394152*a^6*x^2*z^5 - 992934450*a^9*x^2*z^5 + 2225416820160*x*y*z^5 - 839370680400*a^3*x*y*z^5 + 103348968960*a^6*x*y*z^5 - 4354082262*a^9*x*y*z^5 + 1717918025472*y^2*z^5 - 647954987328*a^3*y^2*z^5 + 79780574808*a^6*y^2*z^5 - 3361147812*a^9*y^2*z^5 + 50450765206944*a*x*z^6 - 19028745149952*a^4*x*z^6 + 2342947040004*a^7*x*z^6 - 98708129442*a^10*x*z^6 + 31915925445824*a*y*z^6 - 12037875112640*a^4*y*z^6 + 1482184118528*a^7*y*z^6 - 62444271816*a^10*y*z^6 + 328287914932112*a^2*z^7 - 123821849772488*a^5*z^7 + 15245778645602*a^8*z^7 - 642303162027*a^11*z^7;
f2:=-16816921735648*a*x^7 + 6342915049984*a^4*x^7 - 780982346668*a^7*x^7 + 32902709814*a^10*x^7 - 100901530413888*a*x^6*y + 38057490299904*a^4*x^6*y - 4685894080008*a^7*x^6*y + 197416258884*a^10*x^6*y - 252253826034720*a*x^5*y^2 + 95143725749760*a^4*x^5*y^2 - 11714735200020*a^7*x^5*y^2 + 493540647210*a^10*x^5*y^2 - 336338434712960*a*x^4*y^3 + 126858300999680*a^4*x^4*y^3 - 15619646933360*a^7*x^4*y^3 + 658054196280*a^10*x^4*y^3 - 252253826034720*a*x^3*y^4 + 95143725749760*a^4*x^3*y^4 - 11714735200020*a^7*x^3*y^4 + 493540647210*a^10*x^3*y^4 - 100901530413888*a*x^2*y^5 + 38057490299904*a^4*x^2*y^5 - 4685894080008*a^7*x^2*y^5 + 197416258884*a^10*x^2*y^5 - 16816921735648*a*x*y^6 + 6342915049984*a^4*x*y^6 - 780982346668*a^7*x*y^6 + 32902709814*a^10*x*y^6 + 378738680139056*a^2*x^6*z - 142850594922440*a^5*x^6*z + 17588725685606*a^8*x^6*z - 741011291469*a^11*x^6*z + 1136216040417168*a^2*x^5*y*z - 428551784767320*a^5*x^5*y*z + 52766177056818*a^8*x^5*y*z - 2223033874407*a^11*x^5*y*z - 3787386801390560*a^2*x^3*y^3*z + 1428505949224400*a^5*x^3*y^3*z - 175887256856060*a^8*x^3*y^3*z + 7410112914690*a^11*x^3*y^3*z - 5681080202085840*a^2*x^2*y^4*z + 2142758923836600*a^5*x^2*y^4*z - 263830885284090*a^8*x^2*y^4*z + 11115169372035*a^11*x^2*y^4*z - 3408648121251504*a^2*x*y^5*z + 1285655354301960*a^5*x*y^5*z - 158298531170454*a^8*x*y^5*z + 6669101623221*a^11*x*y^5*z - 757477360278112*a^2*y^6*z + 285701189844880*a^5*y^6*z - 35177451371212*a^8*y^6*z + 1482022582938*a^11*y^6*z + 1717918025472*x^5*z^2 - 647954987328*a^3*x^5*z^2 + 79780574808*a^6*x^5*z^2 - 3361147812*a^9*x^5*z^2 + 7457162505024*x^4*y*z^2 - 2812652019120*a^3*x^4*y*z^2 + 346312627464*a^6*x^4*y*z^2 - 14590117062*a^9*x^4*y*z^2 + 12649469765376*x^3*y^2*z^2 - 4771058203200*a^3*x^3*y^2*z^2 + 587444761776*a^6*x^3*y^2*z^2 - 24748990128*a^9*x^3*y^2*z^2 + 10384614520704*x^2*y^3*z^2 - 3916812368160*a^3*x^2*y^3*z^2 + 482264268624*a^6*x^2*y^3*z^2 - 20317746132*a^9*x^2*y^3*z^2 + 4059879638016*x*y^4*z^2 - 1531283266560*a^3*x*y^4*z^2 + 188541887736*a^6*x*y^4*z^2 - 7943251068*a^9*x*y^4*z^2 + 585490403136*y^5*z^2 - 220832069808*a^3*y^5*z^2 + 27190328232*a^6*y^5*z^2 - 1145525814*a^9*y^5*z^2 + 15099003710176*a*x^4*z^3 - 5694960062656*a^4*x^4*z^3 + 701201771860*a^7*x^4*z^3 - 29541562002*a^10*x^4*z^3 - 55604519283360*a*x^3*y*z^3 + 20972610111936*a^4*x^3*y*z^3 - 2582288764428*a^7*x^3*y*z^3 + 108791572878*a^10*x^3*y*z^3 - 257407580111136*a*x^2*y^2*z^3 + 97087590711744*a^4*x^2*y^2*z^3 - 11954076924444*a^7*x^2*y^2*z^3 + 503624090646*a^10*x^2*y^2*z^3 - 287605587531488*a*x*y^3*z^3 + 108477510837056*a^4*x*y^3*z^3 - 13356480468164*a^7*x*y^3*z^3 + 562707214650*a^10*x*y^3*z^3 - 100901530413888*a*y^4*z^3 + 38057490299904*a^4*y^4*z^3 - 4685894080008*a^7*y^4*z^3 + 197416258884*a^10*y^4*z^3 + 707026595071168*a^2*x^3*z^4 - 266672444694928*a^5*x^3*z^4 + 32834504331208*a^8*x^3*z^4 - 1383314453496*a^11*x^3*z^4 + 1287568336038000*a^2*x^2*y*z^4 - 485638020217176*a^5*x^2*y*z^4 + 59795018176830*a^8*x^2*y*z^4 - 2519158262733*a^11*x^2*y*z^4 + 454056886862496*a^2*x*y^2*z^4 - 171258706349568*a^5*x*y^2*z^4 + 21086523360036*a^8*x*y^2*z^4 - 888373164978*a^11*x*y^2*z^4 - 126484854104336*a^2*y^3*z^4 + 47706869172680*a^5*y^3*z^4 - 5873990485586*a^8*y^3*z^4 + 247470644259*a^11*y^3*z^4 + 1717918025472*x^2*z^5 - 647954987328*a^3*x^2*z^5 + 79780574808*a^6*x^2*z^5 - 3361147812*a^9*x^2*z^5 + 2225416820160*x*y*z^5 - 839370680400*a^3*x*y*z^5 + 103348968960*a^6*x*y*z^5 - 4354082262*a^9*x*y*z^5 + 507498794688*y^2*z^5 - 191415693072*a^3*y^2*z^5 + 23568394152*a^6*y^2*z^5 - 992934450*a^9*y^2*z^5 + 31915925445824*a*x*z^6 - 12037875112640*a^4*x*z^6 + 1482184118528*a^7*x*z^6 - 62444271816*a^10*x*z^6 + 50450765206944*a*y*z^6 - 19028745149952*a^4*y*z^6 + 2342947040004*a^7*y*z^6 - 98708129442*a^10*y*z^6 + 328287914932112*a^2*z^7 - 123821849772488*a^5*z^7 + 15245778645602*a^8*z^7 - 642303162027*a^11*z^7;
f3:=-3*z*(-190879780608*x^6 + 71994998592*a^3*x^6 - 8864508312*a^6*x^6 + 373460868*a^9*x^6 - 1145278683648*x^5*y + 431969991552*a^3*x^5*y - 53187049872*a^6*x^5*y + 2240765208*a^9*x^5*y - 2863196709120*x^4*y^2 + 1079924978880*a^3*x^4*y^2 - 132967624680*a^6*x^4*y^2 + 5601913020*a^9*x^4*y^2 - 3817595612160*x^3*y^3 + 1439899971840*a^3*x^3*y^3 - 177290166240*a^6*x^3*y^3 + 7469217360*a^9*x^3*y^3 - 2863196709120*x^2*y^4 + 1079924978880*a^3*x^2*y^4 - 132967624680*a^6*x^2*y^4 + 5601913020*a^9*x^2*y^4 - 1145278683648*x*y^5 + 431969991552*a^3*x*y^5 - 53187049872*a^6*x*y^5 + 2240765208*a^9*x*y^5 - 190879780608*y^6 + 71994998592*a^3*y^6 - 8864508312*a^6*y^6 + 373460868*a^9*y^6 + 328287914932112*a^2*x^4*z^2 - 123821849772488*a^5*x^4*z^2 + 15245778645602*a^8*x^4*z^2 - 642303162027*a^11*x^4*z^2 + 1313151659728448*a^2*x^3*y*z^2 - 495287399089952*a^5*x^3*y*z^2 + 60983114582408*a^8*x^3*y*z^2 - 2569212648108*a^11*x^3*y*z^2 + 1969727489592672*a^2*x^2*y^2*z^2 - 742931098634928*a^5*x^2*y^2*z^2 + 91474671873612*a^8*x^2*y^2*z^2 - 3853818972162*a^11*x^2*y^2*z^2 + 1313151659728448*a^2*x*y^3*z^2 - 495287399089952*a^5*x*y^3*z^2 + 60983114582408*a^8*x*y^3*z^2 - 2569212648108*a^11*x*y^3*z^2 + 328287914932112*a^2*y^4*z^2 - 123821849772488*a^5*y^4*z^2 + 15245778645602*a^8*y^4*z^2 - 642303162027*a^11*y^4*z^2 - 550925826112*x^3*z^3 + 207795228208*a^3*x^3*z^3 - 25585148008*a^6*x^3*z^3 + 1077899886*a^9*x^3*z^3 - 1652777478336*x^2*y*z^3 + 623385684624*a^3*x^2*y*z^3 - 76755444024*a^6*x^2*y*z^3 + 3233699658*a^9*x^2*y*z^3 - 1652777478336*x*y^2*z^3 + 623385684624*a^3*x*y^2*z^3 - 76755444024*a^6*x*y^2*z^3 + 3233699658*a^9*x*y^2*z^3 - 550925826112*y^3*z^3 + 207795228208*a^3*y^3*z^3 - 25585148008*a^6*y^3*z^3 + 1077899886*a^9*y^3*z^3 - 50450765206944*a*x^2*z^4 + 19028745149952*a^4*x^2*z^4 - 2342947040004*a^7*x^2*z^4 + 98708129442*a^10*x^2*z^4 - 100901530413888*a*x*y*z^4 + 38057490299904*a^4*x*y*z^4 - 4685894080008*a^7*x*y*z^4 + 197416258884*a^10*x*y*z^4 - 50450765206944*a*y^2*z^4 + 19028745149952*a^4*y^2*z^4 - 2342947040004*a^7*y^2*z^4 + 98708129442*a^10*y^2*z^4 + 429189445346000*a^2*x*z^5 - 161879340072392*a^5*x*z^5 + 19931672725610*a^8*x*z^5 - 839719420911*a^11*x*z^5 + 429189445346000*a^2*y*z^5 - 161879340072392*a^5*y*z^5 + 19931672725610*a^8*y*z^5 - 839719420911*a^11*y*z^5 - 386043248320*z^6 + 145605688528*a^3*z^6 - 17927951056*a^6*z^6 + 755302806*a^9*z^6);
f:=map<E1->E2 | [f1, f2, f3]>;

/* The isogeny f induces an isomorphism E1[3] --> E2[3] that inverts the Weil pairing (can be verified easily on Weierstrass models).
   Therefore f also induces a pair of 3-to-1 coverings C --> E1 and C --> E2 from a genus-2 curve C. We verify that the 3-torsion 
   isomorphism is the one fixed in Theorem 5.7.
*/
f(E1![-1, 0, 1]) eq E2![-1, 0, 1];
f(E1![-w, 1, 0]) eq E2![-w^2, 1, 0];

// Gluing the curves along the 3-torsion via the induced isomorphism yields the curve C (formula in Theorem 5.6)
R<x>:=PolynomialRing(K);
c1:=-3*a^2*b^2 - 4*a^3 - 4*b^3 - 6*a*b + 1;
c2:=func < a, b | 9*(1 - a*b)*(a^2 + b)*(2*b^4 - a^3*b + 3*a*b^2 + 3*a^2 + b) >;
c3:=func < a, b | 3*(-b^4 + 2*a^3*b - 3*a^2 - 2*b) >;
d:=3*a^2*b^2 + a^3 + b^3 - 3*a*b + 2;
C:=HyperellipticCurve(-1/3/d/(d*c1*x^3 + c2(a, b)*x^2 + d*c3(a, b)*x + d^2)*(d^2*x^3 + d*c3(b, a)*x^2 + c2(b, a)*x + d*c1));

// The coverings from Example 3.6 are indeed induced by the isogeny E1 --> E2:
AbsoluteInvariants(C) eq AbsoluteInvariants(HyperellipticCurve(x*(2*x^2 + 4*x + 3)*(3*x^2 + 4*x + 2)));

/* Note: Here we glued the twists:
   u*y^2 = x^3 - x^2 + x + 3
   v*y^2 = x*(x^2 + 44*x + 486)
   so the resulting curve is a twist of y^2 = x*(2*x^2 + 4*x + 3)*(3*x^2 + 4*x + 2)).
*/
